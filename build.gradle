package com.ilabeu.modules;

import com.ilabeu.addon.AddonTemplate;
import meteordevelopment.meteorclient.events.world.TickEvent;
import meteordevelopment.meteorclient.settings.*;
import meteordevelopment.meteorclient.systems.modules.Module;
import meteordevelopment.orbit.EventHandler;
import net.minecraft.entity.vehicle.BoatEntity;

public class BoatFly extends Module {
    private final SettingGroup sgGeneral = settings.getDefaultGroup();

    // Speed settings
    private final Setting<Double> speed = sgGeneral.add(new DoubleSetting.Builder()
        .name("speed")
        .description("Horizontal boat speed.")
        .defaultValue(1.0)
        .min(0.1)
        .sliderMax(5.0)
        .build()
    );

    private final Setting<Double> verticalSpeed = sgGeneral.add(new DoubleSetting.Builder()
        .name("vertical-speed")
        .description("Vertical speed (jump/sneak).")
        .defaultValue(1.0)
        .min(0.1)
        .sliderMax(5.0)
        .build()
    );

    // Acceleration
    private final Setting<Boolean> acceleration = sgGeneral.add(new BoolSetting.Builder()
        .name("acceleration")
        .description("Smooth acceleration.")
        .defaultValue(false)
        .build()
    );

    private final Setting<Double> accelerationSpeed = sgGeneral.add(new DoubleSetting.Builder()
        .name("acceleration-speed")
        .description("Acceleration rate.")
        .defaultValue(0.1)
        .min(0.01)
        .sliderMax(0.5)
        .visible(acceleration::get)
        .build()
    );

    private final Setting<Double> maxSpeed = sgGeneral.add(new DoubleSetting.Builder()
        .name("max-speed")
        .description("Max accelerated speed.")
        .defaultValue(2.0)
        .min(0.1)
        .sliderMax(10.0)
        .visible(acceleration::get)
        .build()
    );

    private final Setting<Boolean> deceleration = sgGeneral.add(new BoolSetting.Builder()
        .name("deceleration")
        .description("Smooth deceleration.")
        .defaultValue(true)
        .visible(acceleration::get)
        .build()
    );

    private final Setting<Double> decelerationSpeed = sgGeneral.add(new DoubleSetting.Builder()
        .name("deceleration-speed")
        .description("Deceleration rate.")
        .defaultValue(0.05)
        .min(0.01)
        .sliderMax(0.5)
        .visible(() -> acceleration.get() && deceleration.get())
        .build()
    );

    private double currentVelocity = 0.0;

    public BoatFly() {
        super(AddonTemplate.CATEGORY, "boat-fly", "Allows boats to fly.");
    }

    @Override
    public void onActivate() {
        currentVelocity = 0.0;
    }

    @Override
    public void onDeactivate() {
        restoreBoat();
        currentVelocity = 0.0;
    }

    @EventHandler
    private void onTick(TickEvent.Pre event) {
        if (mc.player == null) return;
        if (!(mc.player.getVehicle() instanceof BoatEntity boat)) return;

        boat.setNoGravity(true);

        boolean moving =
            mc.options.forwardKey.isPressed() ||
            mc.options.backKey.isPressed() ||
            mc.options.leftKey.isPressed() ||
            mc.options.rightKey.isPressed();

        double targetSpeed;

        if (acceleration.get()) {
            if (moving) {
                currentVelocity = Math.min(
                    currentVelocity + accelerationSpeed.get(),
                    maxSpeed.get()
                );
            } else if (deceleration.get()) {
                currentVelocity = Math.max(
                    currentVelocity - decelerationSpeed.get(),
                    0.0
                );
            } else {
                currentVelocity = 0.0;
            }
            targetSpeed = currentVelocity;
        } else {
            targetSpeed = moving ? speed.get() : 0.0;
        }

        double yaw = Math.toRadians(mc.player.getYaw());
        double x = 0.0;
        double y = 0.0;
        double z = 0.0;

        if (mc.options.forwardKey.isPressed()) {
            x -= Math.sin(yaw) * targetSpeed;
            z += Math.cos(yaw) * targetSpeed;
        }
        if (mc.options.backKey.isPressed()) {
            x += Math.sin(yaw) * targetSpeed;
            z -= Math.cos(yaw) * targetSpeed;
        }
        if (mc.options.leftKey.isPressed()) {
            x -= Math.cos(yaw) * targetSpeed;
            z -= Math.sin(yaw) * targetSpeed;
        }
        if (mc.options.rightKey.isPressed()) {
            x += Math.cos(yaw) * targetSpeed;
            z += Math.sin(yaw) * targetSpeed;
        }

        if (mc.options.jumpKey.isPressed()) {
            y = verticalSpeed.get();
        } else if (mc.options.sneakKey.isPressed()) {
            y = -verticalSpeed.get();
        }

        boat.setVelocity(x, y, z);
    }

    private void restoreBoat() {
        if (mc.player == null) return;
        if (mc.player.getVehicle() instanceof BoatEntity boat) {
            boat.setNoGravity(false);
        }
    }
}
